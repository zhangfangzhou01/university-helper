<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>Websocket</title>
  <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
  <script src="https://cdn.bootcss.com/sockjs-client/1.3.0/sockjs.min.js"></script>
  <script src="https://cdn.bootcss.com/stomp.js/2.3.3/stomp.min.js"></script>
  <script src="https://cdn.bootcdn.net/ajax/libs/jszip/3.6.0/jszip.min.js"></script>
  <script src="https://cdn.bootcdn.net/ajax/libs/axios/1.3.6/axios.min.js"></script>
  <style>
      .box {
          width: 300px;
          float: left;
          margin: 0 20px 0 20px;
      }

      .box div, .box input {
          border: 1px solid;
          -moz-border-radius: 4px;
          border-radius: 4px;
          width: 100%;
          padding: 0;
          margin: 5px;
      }

      .box div {
          border-color: grey;
          height: 300px;
          overflow: auto;
      }

      .box input {
          height: 30px;
      }

      h1 {
          margin-left: 30px;
      }

      body {
          background-color: #F0F0F0;
          font-family: "Arial", serif;
      }
  </style>
</head>

<body>
<h1>Websocket</h1>
<div class="box" id="first">
  <div></div>
  <label>
    发送内容 <input autocomplete="off" value="Type here..."/>
  </label>
  <label>
    接收人 <input autocomplete="off" id="targetOne" value="接收人"/>
  </label>
  <button onclick="connect()">登陆客户端</button>
  <button onclick="send(document.getElementById('targetOne').value)">发送消息</button>
  <button onclick="disconnected()">断开连接</button>
  <button onclick="testLogin()">测试登录接口</button>
  <button onclick="testLogout()">测试登出接口</button>
  <iframe width=0 height=0 id="my-iframe" name="my-iframe"></iframe>
  <form id="my-form" action="http://47.120.32.226/test/upload/task/1" method="post" enctype="multipart/form-data"
        target="my-iframe">
    <label for="type1"></label><input type="text" id="type1" value="task"/>
    <label for="id1"></label><input type="text" id="id1" value="1"/>
    <input id="file-uploaded" type="file" name="files" multiple="multiple"/>
    <input type="button" value="上传文件"
           onclick="document.getElementById('my-form').action='http://47.120.32.226/test/upload/'+document.getElementById('type1').value+'/'+document.getElementById('id1').value;document.getElementById('my-form').submit()"/>
  </form>
  <label for="type"></label><input type="text" id="type" value="task"/>
  <label for="id"></label><input type="text" id="id" value="1"/>
  <label for="fileName1"></label><input type="text" id="fileName1" value="1"/>
  <button onclick="readZip(document.getElementById('type').value, document.getElementById('id').value)">读取全部文件
  </button>
  <button
      onclick="readFile(document.getElementById('type').value, document.getElementById('id').value, document.getElementById('fileName1').value)">
    读取文件
  </button>
  <button onclick="readPreview(document.getElementById('type').value, document.getElementById('id').value)">读取预览
  </button>
  <div id="file" style="width: 100%;"></div>
  <!--  删除图片-->
  <label for="type2"></label><input type="text" id="type2" value="task"/>
  <label for="id2"></label><input type="text" id="id2" value="1"/>
  <label for="fileName"></label><input type="text" id="fileName" value="1"/>
  <button
      onclick="deleteFile(document.getElementById('type2').value, document.getElementById('id2').value, document.getElementById('fileName').value)">
    删除文件
  </button>
  <button onclick="deleteDir(document.getElementById('type2').value, document.getElementById('id2').value)">删除文件夹
  </button>
</div>

<script>
    const input = $('#first input');
    const div = $('#first div');
    let stompClient = null;
    const sockjsUrl = '/api/ws';
    let username;
    let connected = false;

    function print(m, p) {
        p = (p === undefined) ? '' : p;
        div.append($("<code>").text(m + ' ' + p));
        div.append($("<br>"));
        div.scrollTop = div.scrollTop + 10000;
    }

    function send(targetStr) {
        if (stompClient == null) {
            print('系统提示：', '请先点击客户端登陆');
            return false;
        }

        print(username + ": ", input.val());
        // targets是一个数组，如果数组为空，就是广播
        if (targetStr === "") {
            stompClient.send("/app/broadcast", {},
                JSON.stringify({
                    'content': input.val()
                }));
        } else {
            if (targetStr.indexOf(",") !== -1) {
                let targets = targetStr.split(",");
                stompClient.send("/app/groupChat", {},
                    JSON.stringify({
                        'to': targets,
                        'content': input.val()
                    }));
            } else {
                stompClient.send("/app/chat", {},
                    JSON.stringify({
                        'to': targetStr,
                        'content': input.val()
                    }));
            }
        }
    }

    function disconnected() {
        if (!connected) {
            console.log("不要重复断开连接");
            return;
        }
        if (stompClient != null) {
            stompClient.send("/app/disconnected", {},
                JSON.stringify({
                    'from': username
                }));
            stompClient.disconnect();
            stompClient = null;
            connected = false;
            print('系统提示：', '已断开连接');
        }
    }

    function testLogin() {
        // 测试接口可用性
        $.ajax({
            url: "http://47.120.32.226/api/login?password=123456&rememberMe=true&username=2027405037",
            type: "post",
            success: function (data) {
                console.log(data);
            }
        });
    }

    function testLogout() {
        // 测试接口可用性
        $.ajax({
            url: "http://47.120.32.226/api/logout",
            type: "post",
            success: function (data) {
                console.log(data);
            }
        });
    }

    function connect() {
        if (!connected) {
            connected = true;
        } else {
            console.log("不要重复连接");
            return;
        }
        const sockjs = new SockJS(sockjsUrl);
        console.log("sockjs_url:" + sockjsUrl)
        stompClient = Stomp.over(sockjs);
        // yourId = JSON.parse(greeting.body).toUsername;
        // 前端登陆了就会有的
        stompClient.connect({}, () => {
            stompClient.send("/app/connected", {}, {});
            stompClient.subscribe('/topic/broadcast', function (greeting) {
                console.log("返回内容：" + greeting.body);
                print(JSON.parse(greeting.body).fromUsername + "的广播: ", JSON.parse(greeting.body).content);
            })
            stompClient.subscribe('/user/queue/chat', function (greeting) {
                console.log(greeting.body);
                print(JSON.parse(greeting.body).fromUsername + ": ", JSON.parse(greeting.body).content);
            });
            stompClient.subscribe('/user/queue/groupChat', function (greeting) {
                console.log(greeting.body);
                print(JSON.parse(greeting.body).fromUsername + ": ", JSON.parse(greeting.body).content);
            });
            stompClient.subscribe('/topic/notification', function (msg) {
                console.log(msg.body);
                print('系统提示：', msg.body);
            });
            stompClient.subscribe('/user/topic/notification', function (msg) {
                console.log(msg.body);
                print('系统提示：', msg.body);
            });
        });
    }

    async function readZip(type, id) {
        let res = await axios.get(`http://47.120.32.226/test/download/${type}/${id}`, {
            responseType: 'blob'
        })
        const blob = res.data
        let dataList = []
        const jszip = new JSZip()
        let zip = await jszip.loadAsync(blob)
        for (let key in zip.files) { // 判断是否是目录
            if (!zip.files[key].dir) {
                if (/\.(png|jpg|jpeg|gif)$/.test(zip.files[key].name)) { // 判断是否是图片格式
                    let base = await zip.file(zip.files[key].name).async('base64')
                    dataList.push({
                        fileName: zip.files[key].name,
                        type: 'img',
                        content: `data:image/jpg;base64,${base}`
                    })
                }
            }
        }
        console.log(dataList)
        let html = ''
        dataList.forEach(item => {
            html += `<img src="${item.content}" alt="${item.fileName}">`
        })
        document.getElementById('file').innerHTML = html
    }

    async function readFile(type, id, fileName) {
        let res = await axios.get(`http://47.120.32.226/test/download/${type}/${id}/file/${fileName}`, {
            responseType: 'blob'
        })
        const blob = res.data
        document.getElementById('file').innerHTML = `<img src="${URL.createObjectURL(blob)}" alt="${fileName}">`
    }

    async function readPreview(type, id) {
        let res = await axios.get(`http://47.120.32.226/test/download/${type}/${id}/preview`, {
            responseType: 'blob'
        })
        const blob = res.data
        const fileName = res.headers['content-disposition'].split('filename=')[1]
        document.getElementById('file').innerHTML = `<img src="${URL.createObjectURL(blob)}" alt="${fileName}">`
    }

    async function deleteFile(type, id, fileName) {
        let result = await axios.get(`http://47.120.32.226/test/delete/${type}/${id}/${fileName}`)
        console.log(result)
    }

    async function deleteDir(type, id) {
        let result = await axios.get(`http://47.120.32.226/test/delete/${type}/${id}`)
        console.log(result)
    }

    input.focus();
</script>
</body>
</html>